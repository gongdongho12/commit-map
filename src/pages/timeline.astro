---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('posts');

// ë‚ ì§œìˆœ ì •ë ¬
const allPosts = [...posts].sort((a, b) => 
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// ë‚˜ë¼ë³„ í†µê³„
const countryCounts = posts.reduce((acc, post) => {
  const country = post.data.country;
  if (country) {
    acc[country] = (acc[country] || 0) + 1;
  }
  post.data.countries?.forEach(c => {
    if (c !== country) acc[c] = (acc[c] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>);

// ì—¬í–‰ ìœ í˜•ë³„ í†µê³„
const tripTypes: Record<string, { icon: string; label: string }> = {
  sightseeing: { icon: 'ğŸ›ï¸', label: 'ê´€ê´‘' },
  healing: { icon: 'ğŸ§˜', label: 'íë§' },
  food: { icon: 'ğŸ½ï¸', label: 'ë§›ì§‘' },
  culture: { icon: 'ğŸ­', label: 'ë¬¸í™”' },
  nature: { icon: 'ğŸŒ²', label: 'ìì—°' },
  adventure: { icon: 'â›°ï¸', label: 'ëª¨í—˜' },
  shopping: { icon: 'ğŸ›ï¸', label: 'ì‡¼í•‘' },
  business: { icon: 'ğŸ’¼', label: 'ì¶œì¥' },
  family: { icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', label: 'ê°€ì¡±' },
  solo: { icon: 'ğŸš¶', label: 'í˜¼í–‰' },
};

const tripTypeCounts = posts.reduce((acc, post) => {
  post.data.tripType?.forEach(type => {
    acc[type] = (acc[type] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>);

const months = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', 
                '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
---

<BaseLayout title="íƒ€ì„ë¼ì¸">
  <div class="timeline-page">
    <aside class="sidebar">
      <section class="filter-section">
        <h3>ğŸŒ ë‚˜ë¼ë³„ <button class="clear-btn" id="clear-country">ì´ˆê¸°í™”</button></h3>
        <div class="tag-cloud" id="country-filters">
          {Object.entries(countryCounts)
            .sort((a, b) => b[1] - a[1])
            .map(([country, count]) => (
              <button class="filter-tag country-tag" data-filter-type="country" data-filter-value={country}>
                {country} <span class="count">{count}</span>
              </button>
            ))}
        </div>
      </section>

      <section class="filter-section">
        <h3>âœˆï¸ ì—¬í–‰ ìœ í˜• <button class="clear-btn" id="clear-type">ì´ˆê¸°í™”</button></h3>
        <div class="tag-cloud" id="type-filters">
          {Object.entries(tripTypeCounts).map(([type, count]) => (
            <button class="filter-tag type-tag" data-filter-type="tripType" data-filter-value={type}>
              {tripTypes[type]?.icon} {tripTypes[type]?.label}
              <span class="count">{count}</span>
            </button>
          ))}
        </div>
      </section>

      <section class="stats-section">
        <h3>ğŸ“Š í†µê³„</h3>
        <div class="stats">
          <div class="stat-item">
            <span class="stat-value">{posts.length}</span>
            <span class="stat-label">ì—¬í–‰</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{Object.keys(countryCounts).length}</span>
            <span class="stat-label">ë‚˜ë¼</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{posts.reduce((sum, p) => sum + p.data.locations.length, 0)}</span>
            <span class="stat-label">ì¥ì†Œ</span>
          </div>
        </div>
      </section>

      <div class="active-filters" id="active-filters" style="display:none;">
        <h3>ğŸ” ì ìš©ëœ í•„í„°</h3>
        <div id="filter-badges"></div>
      </div>
    </aside>

    <main class="timeline-main">
      <h1>ğŸ—“ï¸ ì—¬í–‰ íƒ€ì„ë¼ì¸</h1>
      
      <div id="posts-container">
        {allPosts.map(post => {
          const year = new Date(post.data.date).getFullYear();
          const month = new Date(post.data.date).getMonth();
          const countries = [post.data.country, ...(post.data.countries || [])].filter(Boolean);
          const types = post.data.tripType || [];
          
          return (
            <a href={`/posts/${post.id}/`} 
               class="timeline-card" 
               data-year={year}
               data-countries={countries.join(',')}
               data-types={types.join(',')}>
              <div class="timeline-date">
                <span class="year">{year}</span>
                <span class="month">{months[month]}</span>
                <span class="day">{new Date(post.data.date).getDate()}</span>
              </div>
              <div class="timeline-content">
                <div class="timeline-header">
                  <span class="country-badge">{post.data.country}</span>
                  {post.data.tripType?.map(type => (
                    <span class="type-badge">
                      {tripTypes[type]?.icon}
                    </span>
                  ))}
                </div>
                <h3>{post.data.title}</h3>
                <p>{post.data.excerpt}</p>
                <div class="timeline-meta">
                  <span>ğŸ“ {post.data.locations.length}ê°œ ì¥ì†Œ</span>
                  {post.data.tags?.slice(0, 3).map(tag => (
                    <span class="mini-tag">#{tag}</span>
                  ))}
                </div>
              </div>
            </a>
          );
        })}
      </div>

      <div id="no-results" style="display:none;">
        <p>í•„í„° ì¡°ê±´ì— ë§ëŠ” ì—¬í–‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    </main>
  </div>
</BaseLayout>

<script>
  // í•„í„° ìƒíƒœ
  let activeCountry: string | null = null;
  let activeType: string | null = null;

  // ìš”ì†Œë“¤
  const countryFilters = document.querySelectorAll('[data-filter-type="country"]');
  const typeFilters = document.querySelectorAll('[data-filter-type="tripType"]');
  const cards = document.querySelectorAll('.timeline-card') as NodeListOf<HTMLElement>;
  const activeFiltersSection = document.getElementById('active-filters')!;
  const filterBadges = document.getElementById('filter-badges')!;
  const noResults = document.getElementById('no-results')!;
  const clearCountryBtn = document.getElementById('clear-country')!;
  const clearTypeBtn = document.getElementById('clear-type')!;

  function applyFilters() {
    let visibleCount = 0;
    
    cards.forEach(card => {
      const countries = card.dataset.countries?.split(',') || [];
      const types = card.dataset.types?.split(',') || [];
      
      const matchesCountry = !activeCountry || countries.includes(activeCountry);
      const matchesType = !activeType || types.includes(activeType);
      
      if (matchesCountry && matchesType) {
        card.style.display = 'flex';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // ê²°ê³¼ ì—†ìŒ í‘œì‹œ
    noResults.style.display = visibleCount === 0 ? 'block' : 'none';

    // í™œì„± í•„í„° í‘œì‹œ
    updateActiveFiltersUI();
  }

  function updateActiveFiltersUI() {
    const hasFilters = activeCountry || activeType;
    activeFiltersSection.style.display = hasFilters ? 'block' : 'none';
    
    if (hasFilters) {
      let badges = '';
      if (activeCountry) {
        badges += `<span class="filter-badge country-badge-active">${activeCountry} âœ•</span>`;
      }
      if (activeType) {
        const typeInfo = {
          sightseeing: 'ğŸ›ï¸ ê´€ê´‘', healing: 'ğŸ§˜ íë§', food: 'ğŸ½ï¸ ë§›ì§‘',
          culture: 'ğŸ­ ë¬¸í™”', nature: 'ğŸŒ² ìì—°', adventure: 'â›°ï¸ ëª¨í—˜',
          shopping: 'ğŸ›ï¸ ì‡¼í•‘', business: 'ğŸ’¼ ì¶œì¥', family: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ê°€ì¡±', solo: 'ğŸš¶ í˜¼í–‰'
        };
        badges += `<span class="filter-badge type-badge-active">${typeInfo[activeType as keyof typeof typeInfo]} âœ•</span>`;
      }
      filterBadges.innerHTML = badges;
    }

    // ë²„íŠ¼ í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
    countryFilters.forEach(btn => {
      btn.classList.toggle('active', btn.getAttribute('data-filter-value') === activeCountry);
    });
    typeFilters.forEach(btn => {
      btn.classList.toggle('active', btn.getAttribute('data-filter-value') === activeType);
    });
  }

  // ë‚˜ë¼ í•„í„° í´ë¦­
  countryFilters.forEach(btn => {
    btn.addEventListener('click', () => {
      const value = btn.getAttribute('data-filter-value');
      activeCountry = activeCountry === value ? null : value;
      applyFilters();
    });
  });

  // ìœ í˜• í•„í„° í´ë¦­
  typeFilters.forEach(btn => {
    btn.addEventListener('click', () => {
      const value = btn.getAttribute('data-filter-value');
      activeType = activeType === value ? null : value;
      applyFilters();
    });
  });

  // ì´ˆê¸°í™” ë²„íŠ¼
  clearCountryBtn.addEventListener('click', () => {
    activeCountry = null;
    applyFilters();
  });
  clearTypeBtn.addEventListener('click', () => {
    activeType = null;
    applyFilters();
  });

  // í™œì„± í•„í„° ë°°ì§€ í´ë¦­ìœ¼ë¡œ ì œê±°
  filterBadges.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (target.classList.contains('country-badge-active')) {
      activeCountry = null;
    } else if (target.classList.contains('type-badge-active')) {
      activeType = null;
    }
    applyFilters();
  });
</script>

<style>
  .timeline-page {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 2rem;
  }

  @media (max-width: 900px) {
    .timeline-page {
      grid-template-columns: 1fr;
    }
    .sidebar {
      order: 1;
    }
  }

  .sidebar {
    position: sticky;
    top: 80px;
    height: fit-content;
  }

  .filter-section, .stats-section, .active-filters {
    background: var(--color-bg-secondary);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    border: 1px solid var(--color-border);
  }

  .filter-section h3, .stats-section h3, .active-filters h3 {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    color: var(--color-text-muted);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .clear-btn {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    border: none;
    background: transparent;
    color: var(--color-text-muted);
    cursor: pointer;
    border-radius: 4px;
  }

  .clear-btn:hover {
    background: var(--color-border);
  }

  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.625rem;
    border-radius: 20px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    font-family: inherit;
  }

  .country-tag {
    background: #e0f2fe;
    color: #0369a1;
  }

  .country-tag:hover, .country-tag.active {
    background: #0ea5e9;
    color: white;
  }

  .type-tag {
    background: #fce7f3;
    color: #be185d;
  }

  .type-tag:hover, .type-tag.active {
    background: #ec4899;
    color: white;
  }

  .count {
    font-size: 0.7rem;
    opacity: 0.8;
  }

  .stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    text-align: center;
  }

  .stat-item {
    padding: 0.5rem;
  }

  .stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  #filter-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .filter-badge {
    padding: 0.375rem 0.625rem;
    border-radius: 20px;
    font-size: 0.8rem;
    cursor: pointer;
  }

  .country-badge-active {
    background: #0ea5e9;
    color: white;
  }

  .type-badge-active {
    background: #ec4899;
    color: white;
  }

  .timeline-main h1 {
    font-size: 1.75rem;
    margin-bottom: 2rem;
  }

  #posts-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .timeline-card {
    display: flex;
    gap: 1rem;
    background: var(--color-bg-secondary);
    border-radius: 12px;
    padding: 1.25rem;
    border: 1px solid var(--color-border);
    transition: all 0.2s;
  }

  .timeline-card:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 20px rgba(67, 97, 238, 0.1);
    border-color: var(--color-primary);
  }

  .timeline-date {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 70px;
    padding-right: 1rem;
    border-right: 2px solid var(--color-border);
  }

  .timeline-date .year {
    font-size: 0.7rem;
    color: var(--color-text-muted);
  }

  .timeline-date .month {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .timeline-date .day {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
  }

  .timeline-content {
    flex: 1;
  }

  .timeline-header {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .country-badge {
    font-size: 0.75rem;
    background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 500;
  }

  .type-badge {
    font-size: 1rem;
  }

  .timeline-content h3 {
    font-size: 1.1rem;
    margin-bottom: 0.375rem;
  }

  .timeline-content p {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
  }

  .timeline-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .mini-tag {
    color: var(--color-accent);
  }

  #no-results {
    text-align: center;
    padding: 2rem;
    color: var(--color-text-muted);
  }
</style>
