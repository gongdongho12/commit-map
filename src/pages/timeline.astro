---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('posts');

// ì—°ë„ë³„ ê·¸ë£¹í•‘
const postsByYear = posts.reduce((acc, post) => {
  const year = new Date(post.data.date).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

// ì—°ë„ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
const sortedYears = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);

// ê° ì—°ë„ ë‚´ì—ì„œ ì›”ë³„ë¡œ ì •ë ¬
sortedYears.forEach(year => {
  postsByYear[year].sort((a, b) => 
    new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
  );
});

// ë‚˜ë¼ë³„ í†µê³„
const countryCounts = posts.reduce((acc, post) => {
  const country = post.data.country;
  if (country) {
    acc[country] = (acc[country] || 0) + 1;
  }
  // ê²½ìœ  ë‚˜ë¼ë“¤ë„ ì¹´ìš´íŠ¸
  post.data.countries?.forEach(c => {
    if (c !== country) acc[c] = (acc[c] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>);

// ì—¬í–‰ ìœ í˜•ë³„ í†µê³„
const tripTypes = {
  sightseeing: { icon: 'ğŸ›ï¸', label: 'ê´€ê´‘' },
  healing: { icon: 'ğŸ§˜', label: 'íë§' },
  food: { icon: 'ğŸ½ï¸', label: 'ë§›ì§‘' },
  culture: { icon: 'ğŸ­', label: 'ë¬¸í™”' },
  nature: { icon: 'ğŸŒ²', label: 'ìì—°' },
  adventure: { icon: 'â›°ï¸', label: 'ëª¨í—˜' },
  shopping: { icon: 'ğŸ›ï¸', label: 'ì‡¼í•‘' },
  business: { icon: 'ğŸ’¼', label: 'ì¶œì¥' },
  family: { icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', label: 'ê°€ì¡±' },
  solo: { icon: 'ğŸš¶', label: 'í˜¼í–‰' },
};

const tripTypeCounts = posts.reduce((acc, post) => {
  post.data.tripType?.forEach(type => {
    acc[type] = (acc[type] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>);

const months = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', 
                '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
---

<BaseLayout title="íƒ€ì„ë¼ì¸">
  <div class="timeline-page">
    <aside class="sidebar">
      <section class="filter-section">
        <h3>ğŸŒ ë‚˜ë¼ë³„</h3>
        <div class="tag-cloud">
          {Object.entries(countryCounts)
            .sort((a, b) => b[1] - a[1])
            .map(([country, count]) => (
              <span class="filter-tag country-tag">
                {country} <span class="count">{count}</span>
              </span>
            ))}
        </div>
      </section>

      <section class="filter-section">
        <h3>âœˆï¸ ì—¬í–‰ ìœ í˜•</h3>
        <div class="tag-cloud">
          {Object.entries(tripTypeCounts).map(([type, count]) => (
            <span class="filter-tag type-tag">
              {tripTypes[type as keyof typeof tripTypes]?.icon} 
              {tripTypes[type as keyof typeof tripTypes]?.label}
              <span class="count">{count}</span>
            </span>
          ))}
        </div>
      </section>

      <section class="stats-section">
        <h3>ğŸ“Š í†µê³„</h3>
        <div class="stats">
          <div class="stat-item">
            <span class="stat-value">{posts.length}</span>
            <span class="stat-label">ì—¬í–‰</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{Object.keys(countryCounts).length}</span>
            <span class="stat-label">ë‚˜ë¼</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">{posts.reduce((sum, p) => sum + p.data.locations.length, 0)}</span>
            <span class="stat-label">ì¥ì†Œ</span>
          </div>
        </div>
      </section>
    </aside>

    <main class="timeline-main">
      <h1>ğŸ—“ï¸ ì—¬í–‰ íƒ€ì„ë¼ì¸</h1>
      
      {sortedYears.map(year => (
        <section class="year-section">
          <h2 class="year-header">{year}ë…„</h2>
          <div class="year-content">
            {postsByYear[year].map(post => {
              const month = new Date(post.data.date).getMonth();
              return (
                <a href={`/commit-map/posts/${post.id}/`} class="timeline-card">
                  <div class="timeline-date">
                    <span class="month">{months[month]}</span>
                    <span class="day">{new Date(post.data.date).getDate()}</span>
                  </div>
                  <div class="timeline-content">
                    <div class="timeline-header">
                      <span class="country-badge">{post.data.country}</span>
                      {post.data.tripType?.map(type => (
                        <span class="type-badge">
                          {tripTypes[type as keyof typeof tripTypes]?.icon}
                        </span>
                      ))}
                    </div>
                    <h3>{post.data.title}</h3>
                    <p>{post.data.excerpt}</p>
                    <div class="timeline-meta">
                      <span>ğŸ“ {post.data.locations.length}ê°œ ì¥ì†Œ</span>
                      {post.data.tags?.slice(0, 3).map(tag => (
                        <span class="mini-tag">#{tag}</span>
                      ))}
                    </div>
                  </div>
                </a>
              );
            })}
          </div>
        </section>
      ))}
    </main>
  </div>
</BaseLayout>

<style>
  .timeline-page {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 2rem;
  }

  @media (max-width: 900px) {
    .timeline-page {
      grid-template-columns: 1fr;
    }
    .sidebar {
      order: 1;
    }
  }

  .sidebar {
    position: sticky;
    top: 80px;
    height: fit-content;
  }

  .filter-section, .stats-section {
    background: var(--color-bg-secondary);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    border: 1px solid var(--color-border);
  }

  .filter-section h3, .stats-section h3 {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    color: var(--color-text-muted);
  }

  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.625rem;
    border-radius: 20px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .country-tag {
    background: #e0f2fe;
    color: #0369a1;
  }

  .country-tag:hover {
    background: #0ea5e9;
    color: white;
  }

  .type-tag {
    background: #fce7f3;
    color: #be185d;
  }

  .type-tag:hover {
    background: #ec4899;
    color: white;
  }

  .count {
    font-size: 0.7rem;
    opacity: 0.8;
  }

  .stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    text-align: center;
  }

  .stat-item {
    padding: 0.5rem;
  }

  .stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .timeline-main h1 {
    font-size: 1.75rem;
    margin-bottom: 2rem;
  }

  .year-section {
    margin-bottom: 2.5rem;
  }

  .year-header {
    font-size: 1.25rem;
    color: var(--color-primary);
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--color-primary);
    margin-bottom: 1rem;
  }

  .year-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .timeline-card {
    display: flex;
    gap: 1rem;
    background: var(--color-bg-secondary);
    border-radius: 12px;
    padding: 1.25rem;
    border: 1px solid var(--color-border);
    transition: all 0.2s;
  }

  .timeline-card:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 20px rgba(67, 97, 238, 0.1);
    border-color: var(--color-primary);
  }

  .timeline-date {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 60px;
    padding-right: 1rem;
    border-right: 2px solid var(--color-border);
  }

  .timeline-date .month {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .timeline-date .day {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-primary);
  }

  .timeline-content {
    flex: 1;
  }

  .timeline-header {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .country-badge {
    font-size: 0.75rem;
    background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 500;
  }

  .type-badge {
    font-size: 1rem;
  }

  .timeline-content h3 {
    font-size: 1.1rem;
    margin-bottom: 0.375rem;
  }

  .timeline-content p {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
  }

  .timeline-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .mini-tag {
    color: var(--color-accent);
  }
</style>
